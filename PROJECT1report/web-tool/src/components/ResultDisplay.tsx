import React from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Download, FileText, Clock, CheckCircle, AlertCircle, Loader2 } from 'lucide-react';
import { NetworkDiagram } from './NetworkDiagram';

interface Result {
  module: string;
  timestamp: string;
  data: any;
  status: 'success' | 'error' | 'warning' | 'loading';
}

interface ResultDisplayProps {
  results: Result[];
}

export const ResultDisplay: React.FC<ResultDisplayProps> = ({ results }) => {
  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'success':
        return <CheckCircle className="w-4 h-4 text-green-400" />;
      case 'error':
        return <AlertCircle className="w-4 h-4 text-red-400" />;
      case 'warning':
        return <AlertCircle className="w-4 h-4 text-yellow-400" />;
      case 'loading':
        return <Loader2 className="w-4 h-4 text-blue-400 animate-spin" />;
      default:
        return <Clock className="w-4 h-4 text-gray-400" />;
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'success':
        return 'bg-green-500/20 text-green-400 border-green-500/30';
      case 'error':
        return 'bg-red-500/20 text-red-400 border-red-500/30';
      case 'warning':
        return 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30';
      case 'loading':
        return 'bg-blue-500/20 text-blue-400 border-blue-500/30';
      default:
        return 'bg-gray-500/20 text-gray-400 border-gray-500/30';
    }
  };

  const formatTimestamp = (timestamp: string) => {
    return new Date(timestamp).toLocaleString('vi-VN');
  };

  const handleExport = async (result: Result, exportType: 'download' | 'view' = 'download') => {
    // X·ª≠ l√Ω kh√°c nhau cho t·ª´ng module
    if ((result.module === 'personal-search' || result.module === 'info-crawl' || result.module === 'osint-api') && result.status === 'success') {
      try {
        // Parse output ƒë·ªÉ t√¨m ƒë∆∞·ªùng d·∫´n file th·ª±c t·∫ø
        const stdout = result.data?.stdout || '';
        let filePathMatch;
        
        if (result.module === 'personal-search') {
          // Pattern cho personal-search: "D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u t·∫°i: path"
          filePathMatch = stdout.match(/D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u t·∫°i: (.+\.json)/);
        } else if (result.module === 'info-crawl') {
          // Pattern cho info-crawl: "üíæ ƒê√£ l∆∞u d·ªØ li·ªáu th√†nh c√¥ng v√†o path" (c√≥ emoji)
          filePathMatch = stdout.match(/üíæ ƒê√£ l∆∞u d·ªØ li·ªáu th√†nh c√¥ng v√†o\s+(.+\.json)/);
        } else if (result.module === 'osint-api') {
          // Pattern cho c√°c API scripts: "ƒê√£ l∆∞u d·ªØ li·ªáu v√†o path"
          filePathMatch = stdout.match(/ƒê√£ l∆∞u d·ªØ li·ªáu v√†o (.+\.json)/);
        }
        
        if (filePathMatch && filePathMatch[1]) {
          const fullPath = filePathMatch[1].trim();
          console.log('Found full file path:', fullPath);
          console.log('Module:', result.module);
          
          // ƒê·ªëi v·ªõi osint-api, c·∫ßn convert absolute path th√†nh relative path
          let relativePath = fullPath;
          if (result.module === 'osint-api' && fullPath.includes('API\\data\\')) {
            // Tr√≠ch xu·∫•t ph·∫ßn t·ª´ API\data\ tr·ªü ƒëi
            const apiIndex = fullPath.indexOf('API\\data\\');
            if (apiIndex !== -1) {
              relativePath = fullPath.substring(apiIndex);
              console.log('Converted to relative path:', relativePath);
            }
          }
          
          // Ki·ªÉm tra file c√≥ t·ªìn t·∫°i kh√¥ng tr∆∞·ªõc khi download
          const checkUrl = `http://localhost:5000/download-file?path=${encodeURIComponent(relativePath)}`;
          
          try {
            const checkResponse = await fetch(checkUrl, { method: 'HEAD' });
            
            if (!checkResponse.ok) {
              // N·∫øu file kh√¥ng t·ªìn t·∫°i, hi·ªÉn th·ªã th√¥ng b√°o v√† fallback
              alert(`File kh√¥ng t·ªìn t·∫°i ho·∫∑c ch∆∞a ƒë∆∞·ª£c t·∫°o.\nModule: ${result.module}\nOriginal: ${fullPath}\nRelative: ${relativePath}\nL·ªói: ${checkResponse.status} ${checkResponse.statusText}\n\nS·∫Ω export JSON response thay th·∫ø.`);
              console.warn('File not found, falling back to JSON export');
            } else {
              // File t·ªìn t·∫°i, ti·∫øn h√†nh download
              const link = document.createElement('a');
              link.href = checkUrl;
              link.download = relativePath.split('\\').pop() || relativePath.split('/').pop() || 'crawled_data.json';
              link.target = '_blank';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              
              // Exit early n·∫øu download th√†nh c√¥ng
              return;
            }
          } catch (fetchError) {
            console.error('Error checking file:', fetchError);
            alert(`L·ªói khi ki·ªÉm tra file: ${fetchError.message}\nS·∫Ω export JSON response thay th·∫ø.`);
          }
        } else {
          console.warn('Could not find file path in output for module:', result.module);
          console.log('Full stdout:', stdout);
          alert(`Kh√¥ng t√¨m th·∫•y ƒë∆∞·ªùng d·∫´n file trong output cho module ${result.module}.\nS·∫Ω export JSON response thay th·∫ø.`);
        }
      } catch (error) {
        console.error('Error in export logic:', error);
        alert(`L·ªói khi x·ª≠ l√Ω export: ${error.message}\nS·∫Ω export JSON response thay th·∫ø.`);
      }
    }
    
    // X·ª≠ l√Ω ri√™ng cho migration-check
    if (result.module === 'migration-check' && result.status === 'success' && result.data?.generated_file) {
      if (exportType === 'download') {
        // Ch·ªâ download file JSON tr·ª±c ti·∫øp, kh√¥ng popup, kh√¥ng m·ªü tab
        try {
          const checkUrl = `http://localhost:5000/download-file?path=${encodeURIComponent(`CrawCheckin/src/data/${result.data.generated_file}`)}`;
          const checkResponse = await fetch(checkUrl, { method: 'HEAD' });
          
          if (checkResponse.ok) {
            // Download file tr·ª±c ti·∫øp
            const link = document.createElement('a');
            link.href = checkUrl;
            link.download = result.data.generated_file;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            return;
          }
        } catch (error) {
          console.error('Error downloading file:', error);
        }
        
        // Fallback: export JSON result
        const dataStr = JSON.stringify(result, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `migration-check-result-${Date.now()}.json`;
        link.click();
        URL.revokeObjectURL(url);
        return;
      } else if (exportType === 'view') {
        // Export v·ªõi popup v√† m·ªü tab m·ªõi
        try {
          // Auto-export qua /move-history endpoint v√† m·ªü checkin_routes.html
          const response = await fetch('http://localhost:5000/move-history', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ file_name: result.data.generated_file })
          });
          
          const exportData = await response.json();
          
          if (!exportData.error) {
            // M·ªü checkin_routes.html trong tab m·ªõi
            setTimeout(() => {
              const checkinUrl = '/hyvongcuoicung/new2/checkin_routes.html';
              window.open(checkinUrl, '_blank');
            }, 1000);
            
            alert(`‚úÖ ƒê√£ export th√†nh c√¥ng file: ${result.data.generated_file}\nData ƒë√£ ƒë∆∞·ª£c ghi v√†o data_checkin.js v√† m·ªü checkin_routes.html`);
            return;
          } else {
            alert(`‚ùå L·ªói khi export: ${exportData.error}`);
          }
        } catch (error) {
          console.error('Error exporting migration-check:', error);
          alert(`‚ùå L·ªói khi export: ${error.message}`);
        }
      }
    }
    
    // Logic export JSON m·∫∑c ƒë·ªãnh cho c√°c module kh√°c ho·∫∑c fallback
    const dataStr = JSON.stringify(result, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `osint-result-${result.module}-${Date.now()}.json`;
    link.click();
    URL.revokeObjectURL(url);
  };

  if (results.length === 0) {
    return (
      <Card className="bg-black/20 border-white/10 backdrop-blur-sm">
        <CardContent className="flex flex-col items-center justify-center py-12">
          <FileText className="w-16 h-16 text-gray-500 mb-4" />
          <h3 className="text-xl font-semibold text-white mb-2">No Results Yet</h3>
          <p className="text-gray-400 text-center">
            Execute an OSINT module to see results here. All investigation data will be displayed and can be exported.
          </p>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <h2 className="text-2xl font-bold text-white">Investigation Results</h2>
        <Badge variant="outline" className="bg-blue-500/20 text-blue-400 border-blue-500/30">
          {results.length} Results
        </Badge>
      </div>
      
      <ScrollArea className="h-[600px] space-y-4">
        {results.map((result, index) => (
          <Card key={index} className="bg-black/20 border-white/10 backdrop-blur-sm mb-4">
            <CardHeader>
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-3">
                  {getStatusIcon(result.status)}
                  <div>
                    <CardTitle className="text-white text-lg">
                      {result.module.replace('-', ' ').toUpperCase()}
                    </CardTitle>
                    <CardDescription className="text-gray-400 flex items-center space-x-2">
                      <Clock className="w-3 h-3" />
                      <span>{formatTimestamp(result.timestamp)}</span>
                    </CardDescription>
                  </div>
                </div>
                <div className="flex items-center space-x-2">
                  <Badge variant="outline" className={getStatusColor(result.status)}>
                    {result.status}
                  </Badge>
                  <Button
                    size="sm"
                    variant="outline"
                    onClick={() => handleExport(result)}
                    className="border-white/20 text-gray-300 hover:bg-white/10"
                  >
                    <Download className="w-4 h-4 mr-1" />
                    Export
                  </Button>
                </div>
              </div>
            </CardHeader>
            <CardContent>
              <div className="bg-black/30 rounded-lg p-4 border border-white/10">
                {result.status === 'loading' ? (
                  <div className="flex flex-col space-y-3 text-blue-400">
                    <div className="flex items-center space-x-2">
                      <Loader2 className="w-5 h-5 animate-spin" />
                      <span>ƒêang ch·∫°y, vui l√≤ng ch·ªù...</span>
                    </div>
                    {result.module === 'info-crawl' && (
                      <div className="text-sm text-gray-400 italic">
                        ‚è±Ô∏è Th·ªùi gian ph·ª• thu·ªôc v√†o s·ªë l∆∞·ª£ng ng∆∞·ªùi (~2-3 ph√∫t/ng∆∞·ªùi).<br/>
                        üîÑ H·ªá th·ªëng ƒëang truy c·∫≠p v√† thu th·∫≠p d·ªØ li·ªáu t·ª´ Facebook.<br/>
                        üìä Qu√° tr√¨nh s·∫Ω ch·∫°y cho ƒë·∫øn khi ho√†n th√†nh.<br/>
                        üí° <strong>Tip:</strong> Theo d√µi log trong terminal ƒë·ªÉ bi·∫øt ti·∫øn ƒë·ªô chi ti·∫øt.
                      </div>
                    )}
                    {result.module === 'personal-search' && (
                      <div className="text-sm text-gray-400 italic">
                        ‚è±Ô∏è Crawl danh s√°ch b·∫°n b√® c√≥ th·ªÉ m·∫•t 1-3 ph√∫t.<br/>
                        üîÑ H·ªá th·ªëng ƒëang truy c·∫≠p Facebook ƒë·ªÉ l·∫•y d·ªØ li·ªáu.
                      </div>
                    )}
                  </div>
                ) : (
                  <div className="space-y-2">
                    {result.module === 'info-crawl' && result.data?.total_profiles && (
                      <div className="bg-blue-900/30 border border-blue-500/30 rounded p-3 mb-3">
                        <div className="text-blue-300 text-sm">
                          üìä <strong>Th√¥ng tin crawl:</strong><br/>
                          üë• T·ªïng s·ªë profile: {result.data.total_profiles}<br/>
                          ‚è±Ô∏è Th·ªùi gian ∆∞·ªõc t√≠nh: ~{result.data.estimated_time_minutes?.toFixed(1)} ph√∫t<br/>
                          üìÅ Th∆∞ m·ª•c: {result.data.friends_dir}
                        </div>
                      </div>
                    )}
                    {result.module === 'network-scan' && result.data?.data_js_created && (
                      <div className="bg-orange-900/30 border border-orange-500/30 rounded p-3 mb-3">
                        <div className="text-orange-300 text-sm">
                          üåê <strong>S∆° ƒë·ªì m·∫°ng ƒë√£ t·∫°o:</strong><br/>
                          üìÅ ƒê√£ t·∫°o file: data.js<br/>
                          üîó HTML file: {result.data.network_html_path}<br/>
                          üí° <strong>C√°ch xem:</strong> M·ªü file network.html trong browser
                        </div>
                      </div>
                    )}
                    {result.module === 'network-scan' && result.data?.tree_data && (
                      <div className="mb-4">
                        <NetworkDiagram data={result.data} width={750} height={500} />
                      </div>
                    )}
                    {result.module === 'migration-check' && result.data?.generated_file && (
                      <div className="bg-teal-900/30 border border-teal-500/30 rounded p-3 mb-3">
                        <div className="text-teal-300 text-sm mb-3">
                          üìä <strong>Check-in data ƒë√£ crawl xong:</strong><br/>
                          üìÅ File ƒë√£ t·∫°o: <span className="font-mono bg-black/30 px-1 rounded">{result.data.generated_file}</span><br/>
                          üí° <strong>H√†nh ƒë·ªông ti·∫øp theo:</strong> Nh·∫•n "Export & View" ƒë·ªÉ xem bi·ªÉu ƒë·ªì di chuy·ªÉn
                        </div>
                        <Button
                          size="sm"
                          onClick={() => handleExport(result, 'view')}
                          className="bg-gradient-to-r from-teal-600 to-blue-600 hover:from-teal-700 hover:to-blue-700 text-white"
                        >
                          <Download className="w-4 h-4 mr-2" />
                          Export & View Routes
                        </Button>
                      </div>
                    )}
                    <pre className="text-green-400 text-sm font-mono overflow-x-auto whitespace-pre-wrap">
                      {typeof result.data === 'string' ? result.data : JSON.stringify(result.data, null, 2)}
                    </pre>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>
        ))}
      </ScrollArea>
    </div>
  );
};
